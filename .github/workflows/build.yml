name: Build Multi-Platform Installers

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build Shadow JAR
        run: ./gradlew clean shadowJar --no-daemon

      - name: Download JavaFX jmods
        run: |
          curl -L -o javafx-jmods.zip https://download2.gluonhq.com/openjfx/21.0.2/openjfx-21.0.2_osx-aarch64_bin-jmods.zip
          unzip javafx-jmods.zip

      - name: Create DMG with jpackage
        run: |
          jpackage \
            --input build/libs \
            --name DominoGame \
            --main-jar DominoGame-1.0.0.jar \
            --main-class org.EntryPoint \
            --type dmg \
            --app-version 1.0.0 \
            --module-path javafx-jmods-21.0.2 \
            --add-modules javafx.controls,javafx.graphics,javafx.media \
            --java-options '--enable-native-access=javafx.graphics'

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: DominoGame-macOS
          path: "*.dmg"

build-windows:
  runs-on: windows-latest
  steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Build Shadow JAR
      run: ./gradlew clean shadowJar --no-daemon
      shell: bash

    - name: Download JavaFX jmods
      run: |
        Invoke-WebRequest -Uri "https://download2.gluonhq.com/openjfx/21.0.2/openjfx-21.0.2_windows-x64_bin-jmods.zip" -OutFile "javafx-jmods.zip"
        Expand-Archive -Path javafx-jmods.zip -DestinationPath .
      shell: powershell

    - name: Create EXE with jpackage
      run: |
        jpackage `
          --input build/libs `
          --name DominoGame `
          --main-jar DominoGame-1.0.0.jar `
          --main-class org.EntryPoint `
          --type exe `
          --app-version 1.0.0 `
          --module-path "javafx-jmods-21.0.2" `
          --add-modules javafx.controls,javafx.graphics,javafx.media `
          --java-options '--enable-native-access=javafx.graphics' `
          --win-console
      shell: powershell

    - name: Upload Windows EXE
      uses: actions/upload-artifact@v4
      with:
        name: DominoGame-Windows
        path: "*.exe"

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build Shadow JAR
        run: ./gradlew clean shadowJar --no-daemon

      - name: Download JavaFX jmods
        run: |
          curl -L -o javafx-jmods.zip https://download2.gluonhq.com/openjfx/21.0.2/openjfx-21.0.2_linux-x64_bin-jmods.zip
          unzip javafx-jmods.zip

      - name: Create DEB with jpackage
        run: |
          jpackage \
            --input build/libs \
            --name DominoGame \
            --main-jar DominoGame-1.0.0.jar \
            --main-class org.EntryPoint \
            --type deb \
            --app-version 1.0.0 \
            --module-path javafx-jmods-21.0.2 \
            --add-modules javafx.controls,javafx.graphics,javafx.media \
            --java-options '--enable-native-access=javafx.graphics'

      - name: Upload Linux DEB
        uses: actions/upload-artifact@v4
        with:
          name: DominoGame-Linux
          path: "*.deb"